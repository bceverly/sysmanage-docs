<!DOCTYPE html>
<html lang="en" data-i18n-title="docs.architecture.message_flow.title">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Flow Architecture - SysManage</title>
    <meta name="description" content="Detailed explanation of message passing, queuing, and state management between SysManage agents and the backend server.">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="../../assets/images/favicon.svg">
    <style>
        .diagram-container {
            margin: 2rem 0;
            text-align: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .diagram-container img {
            max-width: 100%;
            height: auto;
        }

        .flow-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 0 8px 8px 0;
        }

        .message-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .message-type-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-type-card h4 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .message-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .message-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
        }

        .message-list li:last-child {
            border-bottom: none;
        }

        .state-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }

        .state {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
        }

        .state-arrow {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .queue-details {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .queue-details h4 {
            color: #2e7d32;
            margin: 0 0 1rem 0;
        }

        .technical-specs {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .technical-specs h4 {
            color: #e65100;
            margin: 0 0 1rem 0;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .priority-levels {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
        }

        .priority {
            text-align: center;
            padding: 0.5rem;
            border-radius: 4px;
            min-width: 80px;
        }

        .priority.urgent { background: #ffcdd2; color: #c62828; }
        .priority.high { background: #ffe0b2; color: #e65100; }
        .priority.normal { background: #e8f5e8; color: #2e7d32; }
        .priority.low { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <header class="site-header">
        <nav class="navbar">
            <div class="container">
                <div class="nav-brand">
                    <a href="../../">
                        <img src="../../assets/images/sysmanage-icon.svg" alt="SysManage" class="logo">
                    </a>
                </div>
                <div class="nav-menu">
                    <a href="../../#features" class="nav-link" data-i18n="nav.features">Features</a>
                    <a href="../../#getting-started" class="nav-link" data-i18n="nav.getting_started">Getting Started</a>
                    <a href="../" class="nav-link active" data-i18n="nav.documentation">Documentation</a>
                    <a href="https://github.com/bceverly/sysmanage" class="nav-link" target="_blank" data-i18n="nav.github">GitHub</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="docs-main">
        <div class="container">
            <div class="docs-header">
                <h1 data-i18n="docs.architecture.message_flow.title">Message Flow & State Management</h1>
                <p data-i18n="docs.architecture.message_flow.subtitle">Comprehensive overview of how messages are passed, queued, and processed between SysManage agents and the backend server.</p>
            </div>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.overview.title">Architecture Overview</h2>
                <p data-i18n="docs.architecture.message_flow.overview.description">
                    SysManage uses a sophisticated message-passing architecture that ensures reliable, ordered communication between distributed agents and the central server. The system employs persistent message queues on both sides with automatic retry logic, priority handling, and state tracking.
                </p>

                <div class="diagram-container">
                    <img src="/assets/images/message-flow-diagram.svg" alt="SysManage Message Flow Diagram" style="max-width: 100%; height: auto;" />
                    <p><strong>Figure 1:</strong> Complete message flow and state diagram showing bidirectional communication between agents and server</p>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.communication.title">Communication Protocol</h2>

                <div class="flow-section">
                    <h3 data-i18n="docs.architecture.message_flow.communication.websocket.title">WebSocket Layer</h3>
                    <p data-i18n="docs.architecture.message_flow.communication.websocket.description">
                        All real-time communication between agents and the server occurs over WebSocket connections secured with mutual TLS (mTLS). The WebSocket layer provides:
                    </p>
                    <ul>
                        <li><strong>Real-time bidirectional communication</strong> for immediate message delivery</li>
                        <li><strong>Automatic reconnection logic</strong> with exponential backoff</li>
                        <li><strong>Connection state management</strong> and heartbeat monitoring</li>
                        <li><strong>Encrypted transport</strong> using certificate-based authentication</li>
                    </ul>
                </div>

                <div class="flow-section">
                    <h3 data-i18n="docs.architecture.message_flow.communication.queuing.title">Persistent Message Queuing</h3>
                    <p data-i18n="docs.architecture.message_flow.communication.queuing.description">
                        Both agents and server maintain persistent message queues to ensure no data is lost during network interruptions or system restarts:
                    </p>

                    <div class="queue-details">
                        <h4>Agent-Side Queuing (SQLite)</h4>
                        <ul>
                            <li><strong>Local SQLite database</strong> stores messages when connection is unavailable</li>
                            <li><strong>Automatic replay</strong> of queued messages upon reconnection</li>
                            <li><strong>Priority-based processing</strong> ensures critical messages are sent first</li>
                            <li><strong>Retry logic</strong> with configurable maximum attempts</li>
                        </ul>
                    </div>

                    <div class="queue-details">
                        <h4>Server-Side Queuing (PostgreSQL)</h4>
                        <ul>
                            <li><strong>PostgreSQL message_queue table</strong> provides enterprise-grade persistence</li>
                            <li><strong>Host-specific and broadcast queuing</strong> for targeted or fleet-wide operations</li>
                            <li><strong>Correlation tracking</strong> for request/response matching</li>
                            <li><strong>Transaction integrity</strong> ensures consistent state management</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.states.title">Message States & Lifecycle</h2>

                <div class="state-flow">
                    <div class="state">
                        <div><strong>PENDING</strong></div>
                        <div>Queued for processing</div>
                    </div>
                    <div class="state-arrow">→</div>
                    <div class="state">
                        <div><strong>IN_PROGRESS</strong></div>
                        <div>Being transmitted/processed</div>
                    </div>
                    <div class="state-arrow">→</div>
                    <div class="state">
                        <div><strong>COMPLETED</strong></div>
                        <div>Successfully delivered</div>
                    </div>
                </div>

                <p>Messages can also transition to <strong>FAILED</strong> state if maximum retry attempts are exceeded, or <strong>EXPIRED</strong> if they exceed the configured time-to-live.</p>

                <div class="technical-specs">
                    <h4>Message Queue Fields</h4>
                    <div class="code-block">
{
  "message_id": "uuid4-string",
  "direction": "outbound|inbound",
  "message_type": "system_info|command|update_request|...",
  "message_data": "json-encoded-payload",
  "status": "pending|in_progress|completed|failed|expired",
  "priority": "urgent|high|normal|low",
  "retry_count": 0,
  "max_retries": 3,
  "correlation_id": "uuid4-for-request-response-matching",
  "created_at": "2024-01-01T12:00:00Z",
  "scheduled_at": "2024-01-01T12:00:00Z",
  "completed_at": "2024-01-01T12:00:05Z"
}
                    </div>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.types.title">Message Types</h2>

                <div class="message-types">
                    <div class="message-type-card">
                        <h4>Agent → Server (Outbound)</h4>
                        <ul class="message-list">
                            <li>SYSTEM_INFO</li>
                            <li>HEARTBEAT</li>
                            <li>COMMAND_RESULT</li>
                            <li>OS_VERSION_UPDATE</li>
                            <li>HARDWARE_UPDATE</li>
                            <li>SOFTWARE_INVENTORY_UPDATE</li>
                            <li>PACKAGE_UPDATES_UPDATE</li>
                            <li>USER_ACCESS_UPDATE</li>
                            <li>UPDATE_APPLY_RESULT</li>
                            <li>SCRIPT_EXECUTION_RESULT</li>
                            <li>REBOOT_STATUS_UPDATE</li>
                            <li>DIAGNOSTIC_COLLECTION_RESULT</li>
                            <li>ERROR</li>
                        </ul>
                    </div>

                    <div class="message-type-card">
                        <h4>Server → Agent (Inbound)</h4>
                        <ul class="message-list">
                            <li>COMMAND</li>
                            <li>UPDATE_REQUEST</li>
                            <li>PING</li>
                            <li>SHUTDOWN</li>
                            <li>HOST_APPROVED</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.priority.title">Priority & Scheduling</h2>

                <p data-i18n="docs.architecture.message_flow.priority.description">
                    Messages are processed according to priority levels, ensuring critical operations are handled first:
                </p>

                <div class="priority-levels">
                    <div class="priority urgent">
                        <strong>URGENT</strong><br>
                        Emergency shutdown, critical security alerts
                    </div>
                    <div class="priority high">
                        <strong>HIGH</strong><br>
                        Security updates, system commands
                    </div>
                    <div class="priority normal">
                        <strong>NORMAL</strong><br>
                        Regular updates, data collection
                    </div>
                    <div class="priority low">
                        <strong>LOW</strong><br>
                        Heartbeats, routine maintenance
                    </div>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.reliability.title">Reliability Features</h2>

                <div class="flow-section">
                    <h3>Retry Logic</h3>
                    <ul>
                        <li><strong>Exponential backoff</strong> prevents overwhelming disconnected endpoints</li>
                        <li><strong>Configurable retry limits</strong> (default: 3 attempts)</li>
                        <li><strong>Priority-aware scheduling</strong> ensures high-priority messages retry first</li>
                        <li><strong>Dead letter handling</strong> for messages that exceed retry limits</li>
                    </ul>
                </div>

                <div class="flow-section">
                    <h3>Error Handling</h3>
                    <ul>
                        <li><strong>Graceful degradation</strong> during network interruptions</li>
                        <li><strong>Comprehensive error logging</strong> with correlation IDs</li>
                        <li><strong>Automatic recovery</strong> procedures for common failure scenarios</li>
                        <li><strong>Circuit breaker patterns</strong> prevent cascading failures</li>
                    </ul>
                </div>

                <div class="flow-section">
                    <h3>Data Integrity</h3>
                    <ul>
                        <li><strong>Message deduplication</strong> prevents processing duplicates</li>
                        <li><strong>Checksum validation</strong> ensures data integrity</li>
                        <li><strong>Transaction boundaries</strong> maintain database consistency</li>
                        <li><strong>Audit trails</strong> track all message processing activities</li>
                    </ul>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.performance.title">Performance Characteristics</h2>

                <div class="technical-specs">
                    <h4>Scalability Metrics</h4>
                    <ul>
                        <li><strong>Concurrent Connections:</strong> Supports thousands of simultaneous agent connections</li>
                        <li><strong>Message Throughput:</strong> Processes 10,000+ messages per second per server instance</li>
                        <li><strong>Queue Depth:</strong> Handles millions of queued messages with minimal performance impact</li>
                        <li><strong>Latency:</strong> Sub-100ms message delivery under normal network conditions</li>
                        <li><strong>Memory Usage:</strong> Constant memory footprint regardless of queue size</li>
                    </ul>
                </div>
            </section>

            <section class="docs-section">
                <h2 data-i18n="docs.architecture.message_flow.monitoring.title">Monitoring & Observability</h2>

                <p data-i18n="docs.architecture.message_flow.monitoring.description">
                    The message flow system provides comprehensive monitoring capabilities:
                </p>

                <ul>
                    <li><strong>Real-time metrics:</strong> Queue depths, message processing rates, error rates</li>
                    <li><strong>Connection monitoring:</strong> Agent connectivity status, connection quality metrics</li>
                    <li><strong>Performance tracking:</strong> Message latency, throughput statistics</li>
                    <li><strong>Alert integration:</strong> Configurable alerts for queue backups, connection failures</li>
                    <li><strong>Audit logging:</strong> Complete trail of all message processing activities</li>
                </ul>
            </section>

            <div class="docs-footer">
                <p><strong>Next:</strong> <a href="../security/">Security Architecture</a> | <a href="../deployment/">Deployment Guide</a></p>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>SysManage</h3>
                    <p>Modern system management platform for comprehensive infrastructure monitoring and automation.</p>
                </div>
                <div class="footer-section">
                    <h3>Documentation</h3>
                    <ul>
                        <li><a href="../server/">Server Docs</a></li>
                        <li><a href="../agent/">Agent Docs</a></li>
                        <li><a href="../api/">API Reference</a></li>
                        <li><a href="../security/">Security</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Community</h3>
                    <ul>
                        <li><a href="https://github.com/bceverly/sysmanage" target="_blank">GitHub Repository</a></li>
                        <li><a href="https://github.com/bceverly/sysmanage/issues" target="_blank">Issue Tracker</a></li>
                        <li><a href="https://github.com/bceverly/sysmanage/discussions" target="_blank">Discussions</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>License</h3>
                    <p>Licensed under AGPLv3</p>
                    <p><a href="https://github.com/bceverly/sysmanage/blob/main/LICENSE" target="_blank">View License</a></p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 SysManage. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../assets/js/i18n.js"></script>
</body>
</html>