<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scanning - SysManage Security</title>
    <meta name="description" content="Comprehensive guide to SysManage security scanning including vulnerability assessment, compliance scanning, automated security testing, and reporting.">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="../../assets/images/favicon.svg">
</head>
<body>
    <header class="site-header">
        <nav class="navbar">
            <div class="container">
                <div class="nav-brand">
                    <a href="../../">
                        <img src="../../assets/images/sysmanage-logo.svg" alt="SysManage" class="logo">
                    </a>
                </div>
                <div class="nav-menu">
                    <a href="../../#features" class="nav-link" data-i18n="nav.features" data-i18n-html>Features</a>
                    <a href="../../#getting-started" class="nav-link" data-i18n="nav.getting_started" data-i18n-html>Getting Started</a>
                    <a href="../" class="nav-link active" data-i18n="nav.documentation" data-i18n-html>Documentation</a>
                    <a href="../../config-builder.html" class="nav-link" data-i18n="nav.config_builder" data-i18n-html>Configuration Builder</a>
                    <a href="https://github.com/bceverly/sysmanage" class="nav-link" target="_blank" data-i18n="nav.github" data-i18n-html>GitHub</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="docs-main">
        <div class="container">
            <div class="docs-breadcrumb">
                <a href="../">Documentation</a> > <a href="./">Security</a> > <span>Security Scanning</span>
            </div>

            <div class="docs-header">
                <h1>Security Scanning</h1>
                <p>Comprehensive guide to SysManage's security scanning infrastructure including vulnerability assessment, compliance scanning, automated security testing, and reporting.</p>
            </div>

            <div class="docs-content">
                <section class="overview">
                    <h2>Security Scanning Overview</h2>
                    <p>SysManage implements a comprehensive security scanning infrastructure that performs automated vulnerability assessments, compliance checks, and security testing throughout the development and deployment lifecycle. The scanning system integrates multiple specialized tools to provide complete coverage of potential security issues.</p>

                    <div class="scanning-architecture">
                        <h3>Security Scanning Architecture</h3>
                        <pre class="ascii-diagram">
┌─────────────────────────────────────────────────────────────────┐
│                    Security Scanning Pipeline                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │ Static Code │  │ Dependency   │  │ Infrastructure          │ │
│  │ Analysis    │  │ Scanning     │  │ Scanning                │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │ Secrets     │  │ Container    │  │ Compliance              │ │
│  │ Detection   │  │ Scanning     │  │ Scanning                │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │ Dynamic     │  │ Network      │  │ Web Application         │ │
│  │ Analysis    │  │ Scanning     │  │ Scanning                │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  Reporting & Integration                   │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │  SARIF  │ │ GitHub  │ │ Jira    │ │ Slack   │ │ Email   │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                  │
                           Scan Orchestration
                                  │
┌─────────────────────────────────────────────────────────────────┐
│                      Scanning Tools                            │
├─────────────────────────────────────────────────────────────────┤
│  Bandit │ Semgrep │ Safety │ Snyk │ TruffleHog │ Trivy │ OWASP │ │
│  CodeQL │ SonarQube │ Nessus │ OpenVAS │ Nuclei │ Nikto │ etc. │ │
└─────────────────────────────────────────────────────────────────┘
                        </pre>
                    </div>
                </section>

                <section class="scanning-tools">
                    <h2>Security Scanning Tools</h2>

                    <h3>Integrated Scanning Tools</h3>
                    <p>SysManage leverages multiple specialized security scanning tools, each designed for specific security assessment areas.</p>

                    <div class="tools-grid">
                        <div class="tool-category">
                            <h4>🔍 Static Code Analysis</h4>
                            <div class="tools">
                                <div class="tool-item">
                                    <h5>Bandit</h5>
                                    <p>Python security static analysis</p>
                                    <ul>
                                        <li>Common security issue detection</li>
                                        <li>CWE mapping and severity scoring</li>
                                        <li>Custom rule configuration</li>
                                        <li>CI/CD pipeline integration</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>Semgrep</h5>
                                    <p>Multi-language static analysis</p>
                                    <ul>
                                        <li>Cross-language security rules</li>
                                        <li>Custom pattern detection</li>
                                        <li>OWASP Top 10 coverage</li>
                                        <li>Real-time code scanning</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>CodeQL</h5>
                                    <p>Semantic code analysis</p>
                                    <ul>
                                        <li>Deep code understanding</li>
                                        <li>Complex vulnerability detection</li>
                                        <li>GitHub integration</li>
                                        <li>Custom query development</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="tool-category">
                            <h4>📦 Dependency Scanning</h4>
                            <div class="tools">
                                <div class="tool-item">
                                    <h5>Safety</h5>
                                    <p>Python dependency vulnerability scanner</p>
                                    <ul>
                                        <li>PyPI vulnerability database</li>
                                        <li>License compliance checking</li>
                                        <li>Automated remediation suggestions</li>
                                        <li>Policy enforcement</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>Snyk</h5>
                                    <p>Multi-ecosystem vulnerability scanner</p>
                                    <ul>
                                        <li>npm, PyPI, Maven support</li>
                                        <li>Real-time vulnerability monitoring</li>
                                        <li>Fix recommendations</li>
                                        <li>Container image scanning</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>OWASP Dependency Check</h5>
                                    <p>Open source dependency scanner</p>
                                    <ul>
                                        <li>CVE database integration</li>
                                        <li>Multiple language support</li>
                                        <li>Build tool integration</li>
                                        <li>Extensive reporting formats</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="tool-category">
                            <h4>🔐 Secrets Detection</h4>
                            <div class="tools">
                                <div class="tool-item">
                                    <h5>TruffleHog</h5>
                                    <p>High-entropy secrets scanner</p>
                                    <ul>
                                        <li>Git history scanning</li>
                                        <li>Real-time secret detection</li>
                                        <li>Custom entropy thresholds</li>
                                        <li>Multiple output formats</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>GitLeaks</h5>
                                    <p>Git repository secret scanner</p>
                                    <ul>
                                        <li>SAST secrets detection</li>
                                        <li>Pre-commit hook integration</li>
                                        <li>Custom rule configuration</li>
                                        <li>Baseline establishment</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>Detect Secrets</h5>
                                    <p>Enterprise secrets detection</p>
                                    <ul>
                                        <li>Inline detection and prevention</li>
                                        <li>Plugin architecture</li>
                                        <li>Allowlist management</li>
                                        <li>Team collaboration features</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="tool-category">
                            <h4>🌐 Infrastructure Scanning</h4>
                            <div class="tools">
                                <div class="tool-item">
                                    <h5>Nessus</h5>
                                    <p>Comprehensive vulnerability scanner</p>
                                    <ul>
                                        <li>Network vulnerability assessment</li>
                                        <li>Configuration auditing</li>
                                        <li>Compliance reporting</li>
                                        <li>Credentialed scanning</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>OpenVAS</h5>
                                    <p>Open source vulnerability scanner</p>
                                    <ul>
                                        <li>Network security scanning</li>
                                        <li>Authenticated testing</li>
                                        <li>Custom vulnerability tests</li>
                                        <li>Detailed reporting</li>
                                    </ul>
                                </div>
                                <div class="tool-item">
                                    <h5>Nuclei</h5>
                                    <p>Fast vulnerability scanner</p>
                                    <ul>
                                        <li>Template-based scanning</li>
                                        <li>Community-driven templates</li>
                                        <li>High-speed scanning</li>
                                        <li>Custom template creation</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="ci-cd-integration">
                    <h2>CI/CD Pipeline Integration</h2>

                    <h3>Automated Security Scanning</h3>
                    <p>Security scanning is integrated into the CI/CD pipeline to ensure continuous security assessment throughout the development lifecycle.</p>

                    <div class="pipeline-stages">
                        <h4>Pipeline Security Gates</h4>
                        <div class="stages-grid">
                            <div class="stage-item">
                                <h4>1. 📝 Pre-commit</h4>
                                <ul>
                                    <li>Secrets detection (TruffleHog)</li>
                                    <li>Code formatting and linting</li>
                                    <li>Basic security pattern checks</li>
                                    <li>Commit message validation</li>
                                </ul>
                            </div>

                            <div class="stage-item">
                                <h4>2. 🔄 Pull Request</h4>
                                <ul>
                                    <li>Static code analysis (Bandit, Semgrep)</li>
                                    <li>Dependency vulnerability scanning</li>
                                    <li>Security policy compliance checks</li>
                                    <li>Code review integration</li>
                                </ul>
                            </div>

                            <div class="stage-item">
                                <h4>3. 🏗️ Build</h4>
                                <ul>
                                    <li>Container image scanning (Trivy)</li>
                                    <li>License compliance verification</li>
                                    <li>Supply chain security checks</li>
                                    <li>SBOM generation</li>
                                </ul>
                            </div>

                            <div class="stage-item">
                                <h4>4. 🧪 Test</h4>
                                <ul>
                                    <li>Dynamic application security testing</li>
                                    <li>API security testing</li>
                                    <li>Infrastructure security validation</li>
                                    <li>Performance security testing</li>
                                </ul>
                            </div>

                            <div class="stage-item">
                                <h4>5. 🚀 Deploy</h4>
                                <ul>
                                    <li>Configuration security validation</li>
                                    <li>Runtime security monitoring setup</li>
                                    <li>Security baseline establishment</li>
                                    <li>Deployment security verification</li>
                                </ul>
                            </div>

                            <div class="stage-item">
                                <h4>6. 🔍 Production</h4>
                                <ul>
                                    <li>Continuous vulnerability monitoring</li>
                                    <li>Runtime security analysis</li>
                                    <li>Compliance reporting</li>
                                    <li>Incident response integration</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h4>GitHub Actions Security Workflow</h4>
                    <div class="code-block">
                        <pre><code># .github/workflows/security.yml
name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: Upload TruffleHog results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: trufflehog-results.sarif

  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety semgrep

      - name: Run Bandit
        run: |
          bandit -r backend/ -f json -o bandit-results.json || true
          bandit -r backend/ -f sarif -o bandit-results.sarif || true

      - name: Run Safety
        run: |
          safety check --json --output safety-results.json || true

      - name: Run Semgrep
        run: |
          semgrep --config=auto --sarif --output=semgrep-results.sarif backend/ frontend/ || true

      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: bandit-results.sarif

      - name: Upload Semgrep results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: semgrep-results.sarif

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --sarif-file-output=snyk-results.sarif

      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: snyk-results.sarif

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'SysManage'
          path: '.'
          format: 'SARIF'
          out: 'dependency-check-results'

      - name: Upload Dependency Check results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: dependency-check-results.sarif

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t sysmanage:${{ github.sha }} .

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'sysmanage:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: trivy-results.sarif

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  security-policy-check:
    name: Security Policy Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check security.md
        run: |
          if [ ! -f SECURITY.md ]; then
            echo "❌ SECURITY.md file is missing"
            exit 1
          fi

      - name: Validate GitHub Security Policy
        run: |
          # Check for required security configurations
          if [ ! -f .github/dependabot.yml ]; then
            echo "❌ Dependabot configuration missing"
            exit 1
          fi

      - name: Check for hardcoded secrets patterns
        run: |
          # Custom patterns for common secrets
          if grep -r -E "(password|secret|key|token)\s*=\s*['\"][^'\"]{8,}['\"]" --include="*.py" --include="*.js" .; then
            echo "❌ Potential hardcoded secrets detected"
            exit 1
          fi

  notification:
    name: Security Scan Notification
    runs-on: ubuntu-latest
    needs: [secrets-scan, static-analysis, dependency-scan, container-scan, codeql-analysis]
    if: always()
    steps:
      - name: Notify Security Team
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow</code></pre>
                    </div>
                </section>

                <section class="vulnerability-management">
                    <h2>Vulnerability Management</h2>

                    <h3>Vulnerability Assessment Process</h3>
                    <p>SysManage implements a comprehensive vulnerability management process that includes identification, assessment, prioritization, and remediation.</p>

                    <div class="vuln-process">
                        <h4>Vulnerability Management Workflow</h4>
                        <div class="workflow-steps">
                            <div class="step-item">
                                <h4>1. 🔍 Discovery</h4>
                                <ul>
                                    <li>Automated scanning across all assets</li>
                                    <li>Threat intelligence integration</li>
                                    <li>Manual security testing</li>
                                    <li>Bug bounty program integration</li>
                                </ul>
                            </div>

                            <div class="step-item">
                                <h4>2. 📊 Assessment</h4>
                                <ul>
                                    <li>CVSS scoring and risk assessment</li>
                                    <li>Asset criticality evaluation</li>
                                    <li>Exploitability analysis</li>
                                    <li>Business impact assessment</li>
                                </ul>
                            </div>

                            <div class="step-item">
                                <h4>3. 📋 Prioritization</h4>
                                <ul>
                                    <li>Risk-based prioritization matrix</li>
                                    <li>SLA-based response times</li>
                                    <li>Resource allocation planning</li>
                                    <li>Stakeholder communication</li>
                                </ul>
                            </div>

                            <div class="step-item">
                                <h4>4. 🔧 Remediation</h4>
                                <ul>
                                    <li>Patch management and deployment</li>
                                    <li>Configuration changes</li>
                                    <li>Compensating controls</li>
                                    <li>Acceptance of residual risk</li>
                                </ul>
                            </div>

                            <div class="step-item">
                                <h4>5. ✅ Verification</h4>
                                <ul>
                                    <li>Remediation effectiveness testing</li>
                                    <li>Regression testing</li>
                                    <li>Security posture validation</li>
                                    <li>Documentation updates</li>
                                </ul>
                            </div>

                            <div class="step-item">
                                <h4>6. 📈 Reporting</h4>
                                <ul>
                                    <li>Management dashboard updates</li>
                                    <li>Compliance reporting</li>
                                    <li>Trend analysis</li>
                                    <li>Lessons learned documentation</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h4>Risk-Based Prioritization Matrix</h4>
                    <div class="risk-matrix">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Likelihood</th>
                                    <th colspan="4">Impact</th>
                                </tr>
                                <tr>
                                    <th>Low</th>
                                    <th>Medium</th>
                                    <th>High</th>
                                    <th>Critical</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th>Very High</th>
                                    <td class="risk-medium">Medium</td>
                                    <td class="risk-high">High</td>
                                    <td class="risk-critical">Critical</td>
                                    <td class="risk-critical">Critical</td>
                                </tr>
                                <tr>
                                    <th>High</th>
                                    <td class="risk-low">Low</td>
                                    <td class="risk-medium">Medium</td>
                                    <td class="risk-high">High</td>
                                    <td class="risk-critical">Critical</td>
                                </tr>
                                <tr>
                                    <th>Medium</th>
                                    <td class="risk-low">Low</td>
                                    <td class="risk-low">Low</td>
                                    <td class="risk-medium">Medium</td>
                                    <td class="risk-high">High</td>
                                </tr>
                                <tr>
                                    <th>Low</th>
                                    <td class="risk-low">Low</td>
                                    <td class="risk-low">Low</td>
                                    <td class="risk-low">Low</td>
                                    <td class="risk-medium">Medium</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>Vulnerability Management Implementation</h4>
                    <div class="code-block">
                        <pre><code># Vulnerability management system implementation
from dataclasses import dataclass
from enum import Enum
from datetime import datetime, timedelta
import requests

class Severity(Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

class Status(Enum):
    NEW = "new"
    TRIAGED = "triaged"
    IN_PROGRESS = "in_progress"
    RESOLVED = "resolved"
    ACCEPTED = "accepted"
    FALSE_POSITIVE = "false_positive"

@dataclass
class Vulnerability:
    id: str
    title: str
    description: str
    severity: Severity
    cvss_score: float
    cve_id: str = None
    affected_asset: str = None
    discovery_date: datetime = None
    status: Status = Status.NEW
    assignee: str = None
    due_date: datetime = None
    remediation_effort: str = None
    business_impact: str = None

class VulnerabilityManager:
    def __init__(self):
        self.sla_hours = {
            Severity.CRITICAL: 4,
            Severity.HIGH: 24,
            Severity.MEDIUM: 72,
            Severity.LOW: 168
        }

    def calculate_priority(self, vuln: Vulnerability) -> int:
        """Calculate vulnerability priority based on CVSS and business factors"""
        base_score = vuln.cvss_score

        # Asset criticality multiplier
        asset_multiplier = self.get_asset_criticality(vuln.affected_asset)

        # Exploitability factor
        exploitability = self.check_exploit_availability(vuln.cve_id)

        # Business impact factor
        business_factor = self.assess_business_impact(vuln.affected_asset)

        priority_score = (base_score * asset_multiplier *
                         exploitability * business_factor)

        return min(int(priority_score), 100)

    def assign_sla(self, vuln: Vulnerability) -> datetime:
        """Assign SLA based on severity and priority"""
        sla_hours = self.sla_hours.get(vuln.severity, 168)
        return vuln.discovery_date + timedelta(hours=sla_hours)

    def create_remediation_ticket(self, vuln: Vulnerability):
        """Create ticket in issue tracking system"""
        ticket_data = {
            "title": f"[SECURITY] {vuln.title}",
            "description": self.format_ticket_description(vuln),
            "priority": self.calculate_priority(vuln),
            "labels": ["security", "vulnerability", vuln.severity.value],
            "assignee": self.get_security_lead(),
            "due_date": self.assign_sla(vuln).isoformat()
        }

        # Create ticket in Jira/GitHub Issues
        response = requests.post(
            f"{ISSUE_TRACKER_API}/issues",
            json=ticket_data,
            headers={"Authorization": f"Bearer {API_TOKEN}"}
        )

        return response.json()

    def send_notifications(self, vuln: Vulnerability):
        """Send notifications based on severity"""
        if vuln.severity in [Severity.CRITICAL, Severity.HIGH]:
            # Immediate notification for critical/high
            self.send_slack_alert(vuln)
            self.send_email_alert(vuln)

        # Weekly digest for medium/low vulnerabilities
        self.add_to_weekly_digest(vuln)

    def generate_metrics_report(self) -> dict:
        """Generate vulnerability metrics for dashboard"""
        return {
            "total_vulnerabilities": self.count_by_status(),
            "severity_distribution": self.count_by_severity(),
            "sla_compliance": self.calculate_sla_compliance(),
            "remediation_trends": self.get_remediation_trends(),
            "top_vulnerable_assets": self.get_top_vulnerable_assets()
        }

# Automated vulnerability scanning orchestrator
class ScanOrchestrator:
    def __init__(self):
        self.scanners = {
            "nessus": NessusScanner(),
            "openvas": OpenVASScanner(),
            "nuclei": NucleiScanner(),
            "nmap": NmapScanner()
        }

    async def run_comprehensive_scan(self, target_scope: list):
        """Run comprehensive vulnerability scan"""
        results = {}

        for scanner_name, scanner in self.scanners.items():
            try:
                scan_results = await scanner.scan(target_scope)
                results[scanner_name] = scan_results

                # Process and normalize results
                vulnerabilities = await self.normalize_results(
                    scan_results, scanner_name
                )

                # Import into vulnerability management system
                await self.import_vulnerabilities(vulnerabilities)

            except Exception as e:
                logger.error(f"Scanner {scanner_name} failed: {e}")
                continue

        return results

    async def schedule_recurring_scans(self):
        """Schedule regular vulnerability scans"""
        scan_schedules = [
            {"type": "network", "frequency": "daily", "scope": "external"},
            {"type": "web_app", "frequency": "weekly", "scope": "all_apps"},
            {"type": "infrastructure", "frequency": "monthly", "scope": "internal"},
            {"type": "compliance", "frequency": "quarterly", "scope": "all_systems"}
        ]

        for schedule in scan_schedules:
            await self.schedule_scan(schedule)

# Integration with threat intelligence
class ThreatIntelligence:
    def __init__(self):
        self.feeds = [
            "https://cve.mitre.org/data/downloads/allitems.csv",
            "https://api.first.org/data/v1/epss",
            "https://api.vulndb.cyberriskanalytics.com"
        ]

    async def enrich_vulnerability(self, vuln: Vulnerability):
        """Enrich vulnerability with threat intelligence"""
        if vuln.cve_id:
            # Get EPSS score (Exploit Prediction Scoring System)
            epss_score = await self.get_epss_score(vuln.cve_id)

            # Check for known exploits
            known_exploits = await self.check_exploit_db(vuln.cve_id)

            # Get threat actor attribution
            threat_actors = await self.get_threat_actors(vuln.cve_id)

            # Update vulnerability with intelligence
            vuln.epss_score = epss_score
            vuln.known_exploits = known_exploits
            vuln.threat_actors = threat_actors

    async def get_trending_threats(self) -> list:
        """Get trending threats and vulnerabilities"""
        trending = []

        # Analyze recent CVEs with high EPSS scores
        recent_cves = await self.get_recent_cves(days=7)

        for cve in recent_cves:
            epss_score = await self.get_epss_score(cve.id)
            if epss_score > 0.7:  # High exploitation probability
                trending.append({
                    "cve_id": cve.id,
                    "epss_score": epss_score,
                    "description": cve.description,
                    "affected_products": cve.affected_products
                })

        return trending</code></pre>
                    </div>
                </section>

                <section class="compliance-scanning">
                    <h2>Compliance Scanning</h2>

                    <h3>Regulatory Compliance Assessment</h3>
                    <p>SysManage includes comprehensive compliance scanning capabilities to ensure adherence to various regulatory frameworks and industry standards.</p>

                    <div class="compliance-frameworks">
                        <h4>Supported Compliance Frameworks</h4>
                        <div class="frameworks-grid">
                            <div class="framework-item">
                                <h4>📋 SOC 2</h4>
                                <ul>
                                    <li>Security control implementation</li>
                                    <li>Availability monitoring</li>
                                    <li>Processing integrity validation</li>
                                    <li>Confidentiality assessments</li>
                                    <li>Privacy control evaluation</li>
                                </ul>
                            </div>

                            <div class="framework-item">
                                <h4>🏛️ FedRAMP</h4>
                                <ul>
                                    <li>NIST 800-53 control mapping</li>
                                    <li>Continuous monitoring requirements</li>
                                    <li>Security assessment procedures</li>
                                    <li>Configuration management validation</li>
                                    <li>Incident response capabilities</li>
                                </ul>
                            </div>

                            <div class="framework-item">
                                <h4>🔐 ISO 27001</h4>
                                <ul>
                                    <li>Information security controls</li>
                                    <li>Risk management processes</li>
                                    <li>Asset management validation</li>
                                    <li>Access control implementation</li>
                                    <li>Business continuity planning</li>
                                </ul>
                            </div>

                            <div class="framework-item">
                                <h4>💳 PCI DSS</h4>
                                <ul>
                                    <li>Cardholder data protection</li>
                                    <li>Network security requirements</li>
                                    <li>Vulnerability management</li>
                                    <li>Access control measures</li>
                                    <li>Regular security testing</li>
                                </ul>
                            </div>

                            <div class="framework-item">
                                <h4>🏥 HIPAA</h4>
                                <ul>
                                    <li>Administrative safeguards</li>
                                    <li>Physical safeguards</li>
                                    <li>Technical safeguards</li>
                                    <li>PHI protection measures</li>
                                    <li>Breach notification procedures</li>
                                </ul>
                            </div>

                            <div class="framework-item">
                                <h4>🌍 GDPR</h4>
                                <ul>
                                    <li>Data protection by design</li>
                                    <li>Privacy impact assessments</li>
                                    <li>Data subject rights</li>
                                    <li>Breach notification compliance</li>
                                    <li>Consent management</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h4>OpenSCAP Compliance Scanning</h4>
                    <div class="code-block">
                        <pre><code># OpenSCAP compliance scanning configuration
# Install OpenSCAP tools
sudo apt-get install libopenscap8 openscap-utils scap-security-guide

# Download security content
sudo wget -O /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml \
    https://github.com/ComplianceAsCode/content/releases/latest/download/ssg-ubuntu2004-ds.xml

# Run CIS Ubuntu 20.04 LTS benchmark
sudo oscap xccdf eval \
    --profile xccdf_org.ssgproject.content_profile_cis \
    --results scan-results.xml \
    --report scan-report.html \
    /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml

# Run NIST 800-53 controls assessment
sudo oscap xccdf eval \
    --profile xccdf_org.ssgproject.content_profile_moderate \
    --results nist-results.xml \
    --report nist-report.html \
    /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml

# Generate OVAL definitions scan
sudo oscap oval eval \
    --results oval-results.xml \
    --report oval-report.html \
    /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-oval.xml

# Custom compliance scanning script
#!/bin/bash
# /usr/local/bin/compliance-scan.sh

SCAN_DATE=$(date +%Y%m%d_%H%M%S)
RESULTS_DIR="/var/log/compliance-scans"
SCAP_CONTENT="/usr/share/xml/scap/ssg/content"

mkdir -p "$RESULTS_DIR/$SCAN_DATE"

# Function to run compliance scan
run_compliance_scan() {
    local profile=$1
    local profile_name=$2
    local content_file=$3

    echo "Running $profile_name compliance scan..."

    oscap xccdf eval \
        --profile "$profile" \
        --results "$RESULTS_DIR/$SCAN_DATE/${profile_name}-results.xml" \
        --report "$RESULTS_DIR/$SCAN_DATE/${profile_name}-report.html" \
        --oval-results \
        "$content_file"

    # Generate JSON summary for API integration
    oscap xccdf eval \
        --profile "$profile" \
        --results-arf "$RESULTS_DIR/$SCAN_DATE/${profile_name}-arf.xml" \
        "$content_file"
}

# Run multiple compliance frameworks
run_compliance_scan "xccdf_org.ssgproject.content_profile_cis" "CIS" \
    "$SCAP_CONTENT/ssg-ubuntu2004-ds.xml"

run_compliance_scan "xccdf_org.ssgproject.content_profile_moderate" "NIST-800-53" \
    "$SCAP_CONTENT/ssg-ubuntu2004-ds.xml"

run_compliance_scan "xccdf_org.ssgproject.content_profile_pci-dss" "PCI-DSS" \
    "$SCAP_CONTENT/ssg-ubuntu2004-ds.xml"

# Generate compliance dashboard data
python3 /usr/local/bin/generate-compliance-metrics.py "$RESULTS_DIR/$SCAN_DATE"

# Upload results to SysManage API
curl -X POST "https://sysmanage.company.com/api/compliance/results" \
     -H "Authorization: Bearer $SYSMANAGE_API_TOKEN" \
     -H "Content-Type: application/json" \
     -d @"$RESULTS_DIR/$SCAN_DATE/compliance-summary.json"

echo "Compliance scan completed. Results saved to $RESULTS_DIR/$SCAN_DATE"</code></pre>
                    </div>

                    <h3>Custom Compliance Rules</h3>
                    <div class="code-block">
                        <pre><code># Custom compliance rule implementation
import yaml
from dataclasses import dataclass
from typing import List, Dict, Any

@dataclass
class ComplianceRule:
    id: str
    title: str
    description: str
    framework: str
    control_id: str
    severity: str
    check_type: str
    check_command: str
    expected_result: str
    remediation: str

class ComplianceScanner:
    def __init__(self, rules_file: str):
        self.rules = self.load_rules(rules_file)
        self.results = []

    def load_rules(self, rules_file: str) -> List[ComplianceRule]:
        """Load compliance rules from YAML configuration"""
        with open(rules_file, 'r') as f:
            rules_data = yaml.safe_load(f)

        rules = []
        for rule_data in rules_data['rules']:
            rule = ComplianceRule(**rule_data)
            rules.append(rule)

        return rules

    async def run_scan(self) -> Dict[str, Any]:
        """Execute all compliance rules and generate report"""
        scan_results = {
            "scan_id": self.generate_scan_id(),
            "timestamp": datetime.now().isoformat(),
            "total_rules": len(self.rules),
            "passed": 0,
            "failed": 0,
            "skipped": 0,
            "results": []
        }

        for rule in self.rules:
            try:
                result = await self.execute_rule(rule)
                scan_results["results"].append(result)

                if result["status"] == "pass":
                    scan_results["passed"] += 1
                elif result["status"] == "fail":
                    scan_results["failed"] += 1
                else:
                    scan_results["skipped"] += 1

            except Exception as e:
                logger.error(f"Rule {rule.id} execution failed: {e}")
                scan_results["skipped"] += 1

        # Calculate compliance score
        total_evaluated = scan_results["passed"] + scan_results["failed"]
        if total_evaluated > 0:
            scan_results["compliance_score"] = (
                scan_results["passed"] / total_evaluated * 100
            )
        else:
            scan_results["compliance_score"] = 0

        return scan_results

    async def execute_rule(self, rule: ComplianceRule) -> Dict[str, Any]:
        """Execute individual compliance rule"""
        result = {
            "rule_id": rule.id,
            "title": rule.title,
            "framework": rule.framework,
            "control_id": rule.control_id,
            "severity": rule.severity,
            "status": "unknown",
            "actual_result": None,
            "expected_result": rule.expected_result,
            "message": "",
            "remediation": rule.remediation
        }

        try:
            if rule.check_type == "command":
                actual_result = await self.execute_command(rule.check_command)
            elif rule.check_type == "file_check":
                actual_result = await self.check_file(rule.check_command)
            elif rule.check_type == "service_check":
                actual_result = await self.check_service(rule.check_command)
            elif rule.check_type == "network_check":
                actual_result = await self.check_network(rule.check_command)
            else:
                raise ValueError(f"Unknown check type: {rule.check_type}")

            result["actual_result"] = actual_result

            # Compare actual vs expected result
            if self.compare_results(actual_result, rule.expected_result):
                result["status"] = "pass"
                result["message"] = "Compliance rule satisfied"
            else:
                result["status"] = "fail"
                result["message"] = f"Expected: {rule.expected_result}, Got: {actual_result}"

        except Exception as e:
            result["status"] = "error"
            result["message"] = f"Rule execution error: {str(e)}"

        return result

# Example compliance rules configuration
# compliance-rules.yaml
rules:
  - id: "SYS-001"
    title: "SSH Protocol Version"
    description: "Ensure SSH protocol version 2 is configured"
    framework: "CIS"
    control_id: "5.2.1"
    severity: "high"
    check_type: "command"
    check_command: "grep '^Protocol' /etc/ssh/sshd_config"
    expected_result: "Protocol 2"
    remediation: "Edit /etc/ssh/sshd_config and set Protocol 2"

  - id: "SYS-002"
    title: "Root Login Disabled"
    description: "Ensure SSH root login is disabled"
    framework: "CIS"
    control_id: "5.2.8"
    severity: "critical"
    check_type: "command"
    check_command: "grep '^PermitRootLogin' /etc/ssh/sshd_config"
    expected_result: "PermitRootLogin no"
    remediation: "Edit /etc/ssh/sshd_config and set PermitRootLogin no"

  - id: "NET-001"
    title: "IP Forwarding Disabled"
    description: "Ensure IP forwarding is disabled"
    framework: "CIS"
    control_id: "3.1.1"
    severity: "medium"
    check_type: "command"
    check_command: "sysctl net.ipv4.ip_forward"
    expected_result: "net.ipv4.ip_forward = 0"
    remediation: "Set net.ipv4.ip_forward = 0 in /etc/sysctl.conf"

  - id: "AUTH-001"
    title: "Password Minimum Length"
    description: "Ensure password minimum length is configured"
    framework: "CIS"
    control_id: "5.3.1"
    severity: "medium"
    check_type: "command"
    check_command: "grep '^minlen' /etc/security/pwquality.conf"
    expected_result: "minlen = 14"
    remediation: "Set minlen = 14 in /etc/security/pwquality.conf"

  - id: "LOG-001"
    title: "Audit Log Storage Size"
    description: "Ensure audit log storage size is configured"
    framework: "CIS"
    control_id: "4.1.1.1"
    severity: "low"
    check_type: "command"
    check_command: "grep '^max_log_file' /etc/audit/auditd.conf"
    expected_result: "max_log_file = 8"
    remediation: "Set max_log_file = 8 in /etc/audit/auditd.conf"</code></pre>
                    </div>
                </section>

                <section class="reporting-analytics">
                    <h2>Security Reporting & Analytics</h2>

                    <h3>Comprehensive Security Dashboard</h3>
                    <p>SysManage provides real-time security dashboards and detailed analytics to track security posture and trends.</p>

                    <div class="dashboard-metrics">
                        <h4>Key Security Metrics</h4>
                        <div class="metrics-grid">
                            <div class="metric-category">
                                <h4>🔍 Vulnerability Metrics</h4>
                                <ul>
                                    <li>Total vulnerabilities by severity</li>
                                    <li>Vulnerability discovery trends</li>
                                    <li>Time to remediation (TTR)</li>
                                    <li>SLA compliance rates</li>
                                    <li>Asset vulnerability density</li>
                                    <li>Remediation effectiveness</li>
                                </ul>
                            </div>

                            <div class="metric-category">
                                <h4>📊 Compliance Metrics</h4>
                                <ul>
                                    <li>Overall compliance score</li>
                                    <li>Framework-specific compliance</li>
                                    <li>Control implementation status</li>
                                    <li>Compliance trend analysis</li>
                                    <li>Audit readiness score</li>
                                    <li>Remediation priority queue</li>
                                </ul>
                            </div>

                            <div class="metric-category">
                                <h4>🔐 Security Posture</h4>
                                <ul>
                                    <li>Security score trending</li>
                                    <li>Threat exposure metrics</li>
                                    <li>Attack surface analysis</li>
                                    <li>Security control effectiveness</li>
                                    <li>Risk reduction progress</li>
                                    <li>Security investment ROI</li>
                                </ul>
                            </div>

                            <div class="metric-category">
                                <h4>⚡ Operational Metrics</h4>
                                <ul>
                                    <li>Scan coverage percentage</li>
                                    <li>False positive rates</li>
                                    <li>Scanner performance metrics</li>
                                    <li>Alert response times</li>
                                    <li>Team productivity metrics</li>
                                    <li>Tool effectiveness analysis</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h4>Security Metrics API</h4>
                    <div class="code-block">
                        <pre><code># Security metrics and reporting API
from fastapi import APIRouter, Depends, Query
from datetime import datetime, timedelta
from typing import Optional, List

router = APIRouter(prefix="/api/security/metrics")

@router.get("/vulnerability-summary")
async def get_vulnerability_summary(
    start_date: Optional[datetime] = Query(None),
    end_date: Optional[datetime] = Query(None),
    asset_filter: Optional[List[str]] = Query(None)
):
    """Get vulnerability summary metrics"""
    if not start_date:
        start_date = datetime.now() - timedelta(days=30)
    if not end_date:
        end_date = datetime.now()

    summary = await calculate_vulnerability_metrics(
        start_date, end_date, asset_filter
    )

    return {
        "period": {
            "start": start_date.isoformat(),
            "end": end_date.isoformat()
        },
        "summary": {
            "total_vulnerabilities": summary.total,
            "by_severity": {
                "critical": summary.critical,
                "high": summary.high,
                "medium": summary.medium,
                "low": summary.low
            },
            "newly_discovered": summary.new_discoveries,
            "remediated": summary.remediated,
            "overdue": summary.overdue
        },
        "trends": {
            "discovery_rate": summary.discovery_trend,
            "remediation_rate": summary.remediation_trend,
            "backlog_trend": summary.backlog_trend
        },
        "sla_metrics": {
            "on_time_remediation": summary.sla_compliance,
            "average_ttr_hours": summary.avg_time_to_resolve,
            "critical_ttr_hours": summary.critical_ttr,
            "high_ttr_hours": summary.high_ttr
        }
    }

@router.get("/compliance-dashboard")
async def get_compliance_dashboard(
    frameworks: Optional[List[str]] = Query(None)
):
    """Get compliance dashboard data"""
    if not frameworks:
        frameworks = ["CIS", "NIST-800-53", "SOC2", "PCI-DSS"]

    compliance_data = {}

    for framework in frameworks:
        framework_data = await get_framework_compliance(framework)
        compliance_data[framework] = {
            "overall_score": framework_data.score,
            "total_controls": framework_data.total_controls,
            "implemented": framework_data.implemented,
            "partially_implemented": framework_data.partial,
            "not_implemented": framework_data.not_implemented,
            "last_assessment": framework_data.last_scan.isoformat(),
            "trend": framework_data.trend,
            "critical_gaps": framework_data.critical_gaps
        }

    return {
        "frameworks": compliance_data,
        "overall_compliance": calculate_overall_compliance(compliance_data),
        "recommendations": generate_compliance_recommendations(compliance_data)
    }

@router.get("/security-score")
async def get_security_score():
    """Calculate overall security score"""
    # Gather data from multiple sources
    vulnerability_score = await calculate_vulnerability_score()
    compliance_score = await calculate_compliance_score()
    configuration_score = await calculate_configuration_score()
    patch_score = await calculate_patch_management_score()

    # Weighted security score calculation
    weights = {
        "vulnerabilities": 0.30,
        "compliance": 0.25,
        "configuration": 0.25,
        "patch_management": 0.20
    }

    overall_score = (
        vulnerability_score * weights["vulnerabilities"] +
        compliance_score * weights["compliance"] +
        configuration_score * weights["configuration"] +
        patch_score * weights["patch_management"]
    )

    return {
        "overall_score": round(overall_score, 2),
        "grade": calculate_security_grade(overall_score),
        "components": {
            "vulnerability_management": {
                "score": vulnerability_score,
                "weight": weights["vulnerabilities"]
            },
            "compliance": {
                "score": compliance_score,
                "weight": weights["compliance"]
            },
            "configuration_security": {
                "score": configuration_score,
                "weight": weights["configuration"]
            },
            "patch_management": {
                "score": patch_score,
                "weight": weights["patch_management"]
            }
        },
        "recommendations": generate_security_recommendations(overall_score),
        "historical_trend": await get_security_score_trend(30)  # 30 days
    }

@router.get("/threat-landscape")
async def get_threat_landscape():
    """Get threat landscape analysis"""
    threat_data = await analyze_threat_landscape()

    return {
        "threat_summary": {
            "active_threats": threat_data.active_count,
            "high_risk_assets": threat_data.high_risk_assets,
            "attack_vectors": threat_data.attack_vectors,
            "trending_threats": threat_data.trending_threats
        },
        "risk_analysis": {
            "overall_risk_score": threat_data.risk_score,
            "risk_factors": threat_data.risk_factors,
            "mitigation_effectiveness": threat_data.mitigation_score
        },
        "recommendations": {
            "immediate_actions": threat_data.immediate_actions,
            "strategic_improvements": threat_data.strategic_improvements,
            "resource_requirements": threat_data.resource_needs
        }
    }

# Automated reporting system
class SecurityReportGenerator:
    def __init__(self):
        self.templates = {
            "executive": "executive_summary.html",
            "technical": "technical_details.html",
            "compliance": "compliance_report.html",
            "trend": "trend_analysis.html"
        }

    async def generate_executive_report(self, period_days: int = 30):
        """Generate executive security summary report"""
        end_date = datetime.now()
        start_date = end_date - timedelta(days=period_days)

        # Gather executive-level metrics
        vulnerability_summary = await self.get_vulnerability_summary(start_date, end_date)
        compliance_status = await self.get_compliance_status()
        security_score = await self.get_security_score_trend(period_days)
        key_achievements = await self.get_key_achievements(start_date, end_date)
        upcoming_initiatives = await self.get_upcoming_initiatives()

        report_data = {
            "period": f"{start_date.strftime('%B %d, %Y')} - {end_date.strftime('%B %d, %Y')}",
            "executive_summary": {
                "overall_security_score": security_score.current,
                "score_change": security_score.change,
                "critical_vulnerabilities": vulnerability_summary.critical,
                "compliance_score": compliance_status.overall_score,
                "key_metrics": {
                    "vulnerabilities_remediated": vulnerability_summary.remediated,
                    "sla_compliance": vulnerability_summary.sla_compliance,
                    "new_controls_implemented": compliance_status.new_controls
                }
            },
            "risk_assessment": {
                "current_risk_level": self.calculate_risk_level(security_score.current),
                "trend": security_score.trend,
                "top_risks": await self.get_top_risks(5)
            },
            "achievements": key_achievements,
            "upcoming_initiatives": upcoming_initiatives,
            "recommendations": await self.generate_executive_recommendations()
        }

        return await self.render_report("executive", report_data)

    async def schedule_automated_reports(self):
        """Schedule automated report generation"""
        # Daily operational reports
        schedule.every().day.at("08:00").do(
            self.generate_and_send_daily_report
        )

        # Weekly management reports
        schedule.every().monday.at("09:00").do(
            self.generate_and_send_weekly_report
        )

        # Monthly executive reports
        schedule.every().month.do(
            self.generate_and_send_monthly_report
        )

        # Quarterly compliance reports
        schedule.every(3).months.do(
            self.generate_and_send_compliance_report
        )</code></pre>
                    </div>
                </section>

                <section class="integration-automation">
                    <h2>Integration & Automation</h2>

                    <h3>Tool Integration Ecosystem</h3>
                    <p>SysManage integrates with various security tools and platforms to create a comprehensive security ecosystem.</p>

                    <div class="integration-platforms">
                        <h4>Supported Integrations</h4>
                        <div class="platforms-grid">
                            <div class="platform-item">
                                <h4>🔧 Development Tools</h4>
                                <ul>
                                    <li>GitHub/GitLab/Bitbucket</li>
                                    <li>Jenkins/GitHub Actions/GitLab CI</li>
                                    <li>SonarQube/CodeClimate</li>
                                    <li>Docker Registry/Harbor</li>
                                    <li>Artifactory/Nexus</li>
                                </ul>
                            </div>

                            <div class="platform-item">
                                <h4>🎫 Issue Tracking</h4>
                                <ul>
                                    <li>Jira/Linear/Azure DevOps</li>
                                    <li>ServiceNow/Remedy</li>
                                    <li>PagerDuty/Opsgenie</li>
                                    <li>Slack/Microsoft Teams</li>
                                    <li>Email/SMS notifications</li>
                                </ul>
                            </div>

                            <div class="platform-item">
                                <h4>🔒 Security Tools</h4>
                                <ul>
                                    <li>SIEM systems (Splunk, ELK)</li>
                                    <li>Vulnerability scanners</li>
                                    <li>Threat intelligence platforms</li>
                                    <li>Security orchestration (SOAR)</li>
                                    <li>Compliance management tools</li>
                                </ul>
                            </div>

                            <div class="platform-item">
                                <h4>☁️ Cloud Platforms</h4>
                                <ul>
                                    <li>AWS Security Hub/GuardDuty</li>
                                    <li>Azure Security Center</li>
                                    <li>Google Cloud Security Command Center</li>
                                    <li>Kubernetes security tools</li>
                                    <li>Infrastructure as Code scanners</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h4>Webhook Integration Example</h4>
                    <div class="code-block">
                        <pre><code># Webhook integration for security events
from fastapi import APIRouter, BackgroundTasks
import httpx

router = APIRouter(prefix="/api/security/webhooks")

class WebhookManager:
    def __init__(self):
        self.subscribers = {
            "vulnerability_discovered": [],
            "compliance_failure": [],
            "security_incident": [],
            "remediation_completed": []
        }

    async def notify_subscribers(self, event_type: str, event_data: dict):
        """Notify all subscribers of security events"""
        if event_type not in self.subscribers:
            return

        async with httpx.AsyncClient() as client:
            for webhook_url in self.subscribers[event_type]:
                try:
                    await client.post(
                        webhook_url,
                        json={
                            "event_type": event_type,
                            "timestamp": datetime.now().isoformat(),
                            "data": event_data
                        },
                        timeout=10.0
                    )
                except Exception as e:
                    logger.error(f"Webhook notification failed: {e}")

@router.post("/notify/vulnerability")
async def notify_vulnerability_discovered(
    vulnerability_data: dict,
    background_tasks: BackgroundTasks
):
    """Handle vulnerability discovery notifications"""

    # Process high/critical vulnerabilities immediately
    if vulnerability_data.get("severity") in ["high", "critical"]:
        # Create Jira ticket
        background_tasks.add_task(
            create_jira_ticket,
            vulnerability_data
        )

        # Send Slack alert
        background_tasks.add_task(
            send_slack_alert,
            vulnerability_data
        )

        # Trigger SOAR playbook
        background_tasks.add_task(
            trigger_soar_playbook,
            "high_severity_vulnerability",
            vulnerability_data
        )

    # Send to all registered webhooks
    background_tasks.add_task(
        webhook_manager.notify_subscribers,
        "vulnerability_discovered",
        vulnerability_data
    )

    return {"status": "notifications_queued"}

# SOAR integration
class SOARIntegration:
    def __init__(self, soar_api_url: str, api_key: str):
        self.api_url = soar_api_url
        self.api_key = api_key

    async def trigger_playbook(self, playbook_name: str, event_data: dict):
        """Trigger SOAR playbook for automated response"""
        playbook_data = {
            "playbook": playbook_name,
            "inputs": event_data,
            "triggered_by": "sysmanage_security_scanner",
            "priority": self.calculate_priority(event_data)
        }

        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.api_url}/playbooks/trigger",
                json=playbook_data,
                headers={"Authorization": f"Bearer {self.api_key}"}
            )

        return response.json()

# Jira integration for ticket creation
class JiraIntegration:
    def __init__(self, jira_url: str, username: str, api_token: str):
        self.jira_url = jira_url
        self.auth = (username, api_token)

    async def create_security_ticket(self, vulnerability_data: dict):
        """Create Jira ticket for security vulnerability"""
        ticket_data = {
            "fields": {
                "project": {"key": "SEC"},
                "summary": f"[SECURITY] {vulnerability_data['title']}",
                "description": self.format_description(vulnerability_data),
                "issuetype": {"name": "Security Vulnerability"},
                "priority": {"name": self.map_priority(vulnerability_data['severity'])},
                "labels": ["security", "vulnerability", vulnerability_data['severity']],
                "customfield_10001": vulnerability_data.get('cve_id'),  # CVE ID field
                "customfield_10002": vulnerability_data.get('cvss_score'),  # CVSS field
                "assignee": {"name": self.get_security_assignee(vulnerability_data)},
                "duedate": self.calculate_due_date(vulnerability_data['severity'])
            }
        }

        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"{self.jira_url}/rest/api/3/issue",
                json=ticket_data,
                auth=self.auth
            )

        return response.json()

# Slack integration for real-time alerts
class SlackIntegration:
    def __init__(self, webhook_url: str):
        self.webhook_url = webhook_url

    async def send_security_alert(self, event_data: dict):
        """Send security alert to Slack"""
        severity_colors = {
            "critical": "#FF0000",
            "high": "#FF6600",
            "medium": "#FFCC00",
            "low": "#00CC00"
        }

        message = {
            "text": f"🚨 Security Alert: {event_data['title']}",
            "attachments": [
                {
                    "color": severity_colors.get(event_data['severity'], "#808080"),
                    "fields": [
                        {
                            "title": "Severity",
                            "value": event_data['severity'].upper(),
                            "short": True
                        },
                        {
                            "title": "Asset",
                            "value": event_data.get('affected_asset', 'Unknown'),
                            "short": True
                        },
                        {
                            "title": "Description",
                            "value": event_data['description'],
                            "short": False
                        },
                        {
                            "title": "CVE ID",
                            "value": event_data.get('cve_id', 'N/A'),
                            "short": True
                        },
                        {
                            "title": "CVSS Score",
                            "value": str(event_data.get('cvss_score', 'N/A')),
                            "short": True
                        }
                    ],
                    "actions": [
                        {
                            "type": "button",
                            "text": "View Details",
                            "url": f"https://sysmanage.company.com/vulnerabilities/{event_data['id']}"
                        },
                        {
                            "type": "button",
                            "text": "Assign to Me",
                            "name": "assign",
                            "value": event_data['id']
                        }
                    ]
                }
            ]
        }

        async with httpx.AsyncClient() as client:
            await client.post(self.webhook_url, json=message)</code></pre>
                    </div>
                </section>

                <section class="troubleshooting">
                    <h2>Scanning Troubleshooting</h2>

                    <h3>Common Scanning Issues</h3>
                    <div class="troubleshooting-grid">
                        <div class="issue-item">
                            <h4>🚫 False Positives</h4>
                            <ul>
                                <li><strong>Symptoms:</strong> Legitimate code flagged as vulnerable</li>
                                <li><strong>Causes:</strong> Overly aggressive rules, context misunderstanding</li>
                                <li><strong>Solutions:</strong> Tune rules, add suppressions, review manually</li>
                            </ul>
                        </div>

                        <div class="issue-item">
                            <h4>⏱️ Slow Scan Performance</h4>
                            <ul>
                                <li><strong>Symptoms:</strong> Long scan execution times</li>
                                <li><strong>Causes:</strong> Large codebases, resource constraints</li>
                                <li><strong>Solutions:</strong> Optimize scope, parallel scanning, resource scaling</li>
                            </ul>
                        </div>

                        <div class="issue-item">
                            <h4>🔧 Tool Integration Failures</h4>
                            <ul>
                                <li><strong>Symptoms:</strong> Scanner tools failing to execute</li>
                                <li><strong>Causes:</strong> Version incompatibilities, missing dependencies</li>
                                <li><strong>Solutions:</strong> Update tools, fix dependencies, check configurations</li>
                            </ul>
                        </div>

                        <div class="issue-item">
                            <h4>📊 Incomplete Coverage</h4>
                            <ul>
                                <li><strong>Symptoms:</strong> Missing vulnerabilities in results</li>
                                <li><strong>Causes:</strong> Limited scanner capabilities, misconfigurations</li>
                                <li><strong>Solutions:</strong> Multiple tools, manual reviews, expand rules</li>
                            </ul>
                        </div>
                    </div>

                    <h4>Scanner Diagnostic Commands</h4>
                    <div class="code-block">
                        <pre><code># Security scanner troubleshooting commands

# Check Bandit installation and version
bandit --version
python -m bandit --help

# Test Bandit with verbose output
bandit -r backend/ -v -f json

# Verify Semgrep installation
semgrep --version
semgrep --config=auto --dry-run backend/

# Test Safety dependency scanning
safety check --json --full-report

# Check Snyk authentication
snyk auth
snyk test --json

# Verify TruffleHog installation
trufflehog --version
trufflehog --debug git file://. --only-verified

# Test Docker security scanning with Trivy
trivy image --format json python:3.11-slim

# Debug OpenSCAP scanning
oscap info /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml
oscap xccdf eval --dry-run --profile cis /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-ds.xml

# Check network scanner connectivity
nmap -sV -p 443 sysmanage.company.com
nuclei -t cves/ -u https://sysmanage.company.com

# Verify compliance scanner permissions
sudo oscap oval eval --verbose /usr/share/xml/scap/ssg/content/ssg-ubuntu2004-oval.xml</code></pre>
                    </div>
                </section>

                <section class="next-steps">
                    <h2>Next Steps</h2>
                    <p>After implementing security scanning:</p>
                    <ol>
                        <li><strong><a href="best-practices.html">Security Best Practices</a>:</strong> Follow comprehensive security guidelines</li>
                        <li><strong><a href="authentication.html">Authentication</a>:</strong> Configure user authentication systems</li>
                        <li><strong><a href="mtls.html">mTLS Implementation</a>:</strong> Set up certificate-based agent authentication</li>
                        <li><strong><a href="network-security.html">Network Security</a>:</strong> Configure network-level protections</li>
                    </ol>
                </section>
            </div>

            <div class="docs-footer">
                <div class="docs-navigation">
                    <h3>Navigation</h3>
                    <div class="nav-links">
                        <a href="network-security.html" class="nav-link">← Network Security</a>
                        <a href="./" class="nav-link">Security Home →</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 SysManage. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../assets/js/navbar.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/i18n.js"></script>
</body>
</html>