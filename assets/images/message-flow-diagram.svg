<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" viewBox="0 0 1200 800" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- Background -->
  <rect width="1200" height="800" fill="#f8f9fa"/>

  <!-- Title -->
  <text x="600" y="30" font-family="Arial, sans-serif" font-size="20" fill="#2c3e50" font-weight="bold" text-anchor="middle">SysManage Message Flow & State Diagram</text>

  <!-- Agent Side (Left) -->
  <rect x="50" y="60" width="500" height="680" fill="#e8f5e8" stroke="#388e3c" stroke-width="2" rx="10"/>
  <text x="300" y="85" font-family="Arial, sans-serif" font-size="16" fill="#388e3c" font-weight="bold" text-anchor="middle">SysManage Agent</text>

  <!-- Agent Components -->

  <!-- Agent Message Handler -->
  <rect x="80" y="110" width="200" height="80" fill="#c8e6c9" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="180" y="135" font-family="Arial, sans-serif" font-size="12" fill="#388e3c" text-anchor="middle" font-weight="bold">QueuedMessageHandler</text>
  <text x="180" y="150" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Queue management</text>
  <text x="180" y="165" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Retry logic</text>
  <text x="180" y="180" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Persistence</text>

  <!-- Agent SQLite Queue -->
  <rect x="320" y="110" width="200" height="80" fill="#c8e6c9" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="420" y="135" font-family="Arial, sans-serif" font-size="12" fill="#388e3c" text-anchor="middle" font-weight="bold">SQLite Message Queue</text>
  <text x="420" y="150" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Outbound queue</text>
  <text x="420" y="165" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Inbound queue</text>
  <text x="420" y="180" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Status tracking</text>

  <!-- Agent WebSocket -->
  <rect x="200" y="220" width="200" height="60" fill="#a5d6a7" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="300" y="245" font-family="Arial, sans-serif" font-size="12" fill="#388e3c" text-anchor="middle" font-weight="bold">WebSocket Client</text>
  <text x="300" y="260" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Real-time communication</text>
  <text x="300" y="275" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Auto-reconnection</text>

  <!-- Agent Message Types (Outbound) -->
  <rect x="80" y="310" width="200" height="120" fill="#c8e6c9" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="180" y="330" font-family="Arial, sans-serif" font-size="11" fill="#388e3c" text-anchor="middle" font-weight="bold">Outbound Messages</text>
  <text x="180" y="345" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• SYSTEM_INFO</text>
  <text x="180" y="360" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• HEARTBEAT</text>
  <text x="180" y="375" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• COMMAND_RESULT</text>
  <text x="180" y="390" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• SOFTWARE_INVENTORY_UPDATE</text>
  <text x="180" y="405" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• PACKAGE_UPDATES_UPDATE</text>
  <text x="180" y="420" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• ERROR</text>

  <!-- Agent Message Processing -->
  <rect x="320" y="310" width="200" height="120" fill="#c8e6c9" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="420" y="330" font-family="Arial, sans-serif" font-size="11" fill="#388e3c" text-anchor="middle" font-weight="bold">Inbound Processing</text>
  <text x="420" y="345" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• COMMAND</text>
  <text x="420" y="360" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• UPDATE_REQUEST</text>
  <text x="420" y="375" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• PING</text>
  <text x="420" y="390" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• HOST_APPROVED</text>
  <text x="420" y="405" font-family="Arial, sans-serif" font-size="9" fill="#388e3c" text-anchor="middle">• SHUTDOWN</text>

  <!-- Agent Queue States -->
  <rect x="80" y="460" width="440" height="100" fill="#a5d6a7" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="300" y="480" font-family="Arial, sans-serif" font-size="12" fill="#388e3c" text-anchor="middle" font-weight="bold">Message Queue States</text>
  <text x="140" y="500" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle" font-weight="bold">PENDING</text>
  <text x="240" y="500" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle" font-weight="bold">IN_PROGRESS</text>
  <text x="360" y="500" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle" font-weight="bold">COMPLETED</text>
  <text x="460" y="500" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle" font-weight="bold">FAILED</text>

  <!-- State transition arrows -->
  <line x1="170" y1="505" x2="210" y2="505" stroke="#388e3c" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <line x1="270" y1="505" x2="330" y2="505" stroke="#388e3c" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <line x1="270" y1="515" x2="430" y2="515" stroke="#d32f2f" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- Retry logic -->
  <path d="M 460 520 Q 490 540 460 560 Q 430 540 460 520" stroke="#f57c00" stroke-width="2" fill="none" marker-end="url(#arrowhead-orange)"/>
  <text x="490" y="545" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">Retry Logic</text>

  <!-- Agent Collection Services -->
  <rect x="80" y="590" width="440" height="80" fill="#c8e6c9" stroke="#388e3c" stroke-width="1" rx="5"/>
  <text x="300" y="610" font-family="Arial, sans-serif" font-size="12" fill="#388e3c" text-anchor="middle" font-weight="bold">Data Collection Services</text>
  <text x="150" y="630" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• System Info</text>
  <text x="250" y="630" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Hardware Detection</text>
  <text x="350" y="630" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Package Management</text>
  <text x="450" y="630" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Update Detection</text>
  <text x="150" y="650" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• User Access</text>
  <text x="250" y="650" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Security Scanning</text>
  <text x="350" y="650" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Script Execution</text>
  <text x="450" y="650" font-family="Arial, sans-serif" font-size="10" fill="#388e3c" text-anchor="middle">• Diagnostic Collection</text>

  <!-- Server Side (Right) -->
  <rect x="650" y="60" width="500" height="680" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="10"/>
  <text x="900" y="85" font-family="Arial, sans-serif" font-size="16" fill="#1976d2" font-weight="bold" text-anchor="middle">SysManage Server</text>

  <!-- Server WebSocket Manager -->
  <rect x="680" y="110" width="200" height="80" fill="#bbdefb" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="780" y="135" font-family="Arial, sans-serif" font-size="12" fill="#1976d2" text-anchor="middle" font-weight="bold">ConnectionManager</text>
  <text x="780" y="150" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Agent connections</text>
  <text x="780" y="165" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Connection state</text>
  <text x="780" y="180" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Broadcast support</text>

  <!-- Server Message Processor -->
  <rect x="920" y="110" width="200" height="80" fill="#bbdefb" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="1020" y="135" font-family="Arial, sans-serif" font-size="12" fill="#1976d2" text-anchor="middle" font-weight="bold">MessageProcessor</text>
  <text x="1020" y="150" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Message routing</text>
  <text x="1020" y="165" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Data processing</text>
  <text x="1020" y="180" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Response generation</text>

  <!-- Server PostgreSQL Queue -->
  <rect x="800" y="220" width="200" height="80" fill="#90caf9" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="900" y="245" font-family="Arial, sans-serif" font-size="12" fill="#1976d2" text-anchor="middle" font-weight="bold">PostgreSQL Queue</text>
  <text x="900" y="260" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• message_queue table</text>
  <text x="900" y="275" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Persistent storage</text>
  <text x="900" y="290" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Correlation tracking</text>

  <!-- Server Queue Manager -->
  <rect x="680" y="330" width="200" height="100" fill="#bbdefb" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="780" y="350" font-family="Arial, sans-serif" font-size="11" fill="#1976d2" text-anchor="middle" font-weight="bold">QueueManager</text>
  <text x="780" y="365" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• Message queuing</text>
  <text x="780" y="380" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• Priority handling</text>
  <text x="780" y="395" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• Broadcast queuing</text>
  <text x="780" y="410" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• Retry management</text>
  <text x="780" y="425" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• Status tracking</text>

  <!-- Server API Layer -->
  <rect x="920" y="330" width="200" height="100" fill="#bbdefb" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="1020" y="350" font-family="Arial, sans-serif" font-size="11" fill="#1976d2" text-anchor="middle" font-weight="bold">FastAPI Endpoints</text>
  <text x="1020" y="365" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• /hosts</text>
  <text x="1020" y="380" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• /updates</text>
  <text x="1020" y="395" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• /commands</text>
  <text x="1020" y="410" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• /scripts</text>
  <text x="1020" y="425" font-family="Arial, sans-serif" font-size="9" fill="#1976d2" text-anchor="middle">• User requests</text>

  <!-- Server Database -->
  <rect x="680" y="460" width="440" height="100" fill="#90caf9" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="900" y="480" font-family="Arial, sans-serif" font-size="12" fill="#1976d2" text-anchor="middle" font-weight="bold">PostgreSQL Database</text>
  <text x="780" y="500" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• host table</text>
  <text x="900" y="500" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• message_queue table</text>
  <text x="1020" y="500" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• package_updates table</text>
  <text x="780" y="520" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• software_packages table</text>
  <text x="900" y="520" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• user table</text>
  <text x="1020" y="520" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• scripts table</text>
  <text x="780" y="540" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Session management</text>
  <text x="900" y="540" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Transaction integrity</text>
  <text x="1020" y="540" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Audit logging</text>

  <!-- Server Frontend Interface -->
  <rect x="680" y="590" width="440" height="80" fill="#e1f5fe" stroke="#1976d2" stroke-width="1" rx="5"/>
  <text x="900" y="610" font-family="Arial, sans-serif" font-size="12" fill="#1976d2" text-anchor="middle" font-weight="bold">React Frontend Interface</text>
  <text x="780" y="630" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Dashboard</text>
  <text x="870" y="630" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Host Management</text>
  <text x="970" y="630" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Update Management</text>
  <text x="1060" y="630" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• User Management</text>
  <text x="780" y="650" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Real-time updates</text>
  <text x="870" y="650" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• WebSocket client</text>
  <text x="970" y="650" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• REST API client</text>
  <text x="1060" y="650" font-family="Arial, sans-serif" font-size="10" fill="#1976d2" text-anchor="middle">• Internationalization</text>

  <!-- Communication Flow -->
  <!-- WebSocket Connection -->
  <line x1="400" y1="250" x2="680" y2="150" stroke="#2c3e50" stroke-width="3" stroke-dasharray="10,5"/>
  <text x="540" y="190" font-family="Arial, sans-serif" font-size="11" fill="#2c3e50" text-anchor="middle" font-weight="bold">WebSocket Connection</text>
  <text x="540" y="205" font-family="Arial, sans-serif" font-size="9" fill="#2c3e50" text-anchor="middle">mTLS Encrypted</text>

  <!-- Message Flow Arrows -->
  <!-- Outbound (Agent -> Server) -->
  <path d="M 400 300 Q 540 280 680 320" stroke="#4caf50" stroke-width="3" fill="none" marker-end="url(#arrowhead-green)"/>
  <text x="540" y="275" font-family="Arial, sans-serif" font-size="10" fill="#4caf50" text-anchor="middle" font-weight="bold">Outbound Messages</text>
  <text x="540" y="290" font-family="Arial, sans-serif" font-size="8" fill="#4caf50" text-anchor="middle">System info, Updates, Results</text>

  <!-- Inbound (Server -> Agent) -->
  <path d="M 680 380 Q 540 400 400 360" stroke="#f44336" stroke-width="3" fill="none" marker-end="url(#arrowhead-red)"/>
  <text x="540" y="415" font-family="Arial, sans-serif" font-size="10" fill="#f44336" text-anchor="middle" font-weight="bold">Inbound Messages</text>
  <text x="540" y="430" font-family="Arial, sans-serif" font-size="8" fill="#f44336" text-anchor="middle">Commands, Requests, Control</text>

  <!-- Queue to Database Flow -->
  <line x1="900" y1="300" x2="900" y2="460" stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead-blue)"/>

  <!-- Collection to Queue Flow -->
  <line x1="300" y1="590" x2="300" y2="430" stroke="#388e3c" stroke-width="2" marker-end="url(#arrowhead-green)"/>

  <!-- API to Queue Flow -->
  <line x1="920" y1="380" x2="880" y2="380" stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead-blue)"/>

  <!-- Message Queue Field Details -->
  <rect x="950" y="700" width="200" height="80" fill="#fff3e0" stroke="#f57c00" stroke-width="1" rx="5"/>
  <text x="1050" y="720" font-family="Arial, sans-serif" font-size="11" fill="#f57c00" text-anchor="middle" font-weight="bold">Queue Fields</text>
  <text x="1050" y="735" font-family="Arial, sans-serif" font-size="8" fill="#f57c00" text-anchor="middle">• message_id (UUID)</text>
  <text x="1050" y="747" font-family="Arial, sans-serif" font-size="8" fill="#f57c00" text-anchor="middle">• direction (inbound/outbound)</text>
  <text x="1050" y="759" font-family="Arial, sans-serif" font-size="8" fill="#f57c00" text-anchor="middle">• priority (urgent/high/normal/low)</text>
  <text x="1050" y="771" font-family="Arial, sans-serif" font-size="8" fill="#f57c00" text-anchor="middle">• retry_count/max_retries</text>

  <!-- Arrow definitions -->
  <defs>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4caf50"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f44336"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
    </marker>
    <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f57c00"/>
    </marker>
  </defs>

  <!-- Legend -->
  <rect x="50" y="700" width="180" height="80" fill="#ffffff" stroke="#666" stroke-width="1" rx="5"/>
  <text x="140" y="720" font-family="Arial, sans-serif" font-size="11" fill="#333" text-anchor="middle" font-weight="bold">Legend</text>
  <line x1="60" y1="730" x2="80" y2="730" stroke="#4caf50" stroke-width="3"/>
  <text x="90" y="735" font-family="Arial, sans-serif" font-size="9" fill="#333">Outbound (Agent → Server)</text>
  <line x1="60" y1="745" x2="80" y2="745" stroke="#f44336" stroke-width="3"/>
  <text x="90" y="750" font-family="Arial, sans-serif" font-size="9" fill="#333">Inbound (Server → Agent)</text>
  <line x1="60" y1="760" x2="80" y2="760" stroke="#2c3e50" stroke-width="3" stroke-dasharray="5,2"/>
  <text x="90" y="765" font-family="Arial, sans-serif" font-size="9" fill="#333">WebSocket Connection</text>
</svg>